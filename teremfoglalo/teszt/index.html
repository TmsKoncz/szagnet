<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SZAG Teremfoglaló</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stílusok */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s linear infinite; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 50; padding: 1rem; opacity: 0; transition: opacity 300ms ease-in-out; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: scale(0.95); transition: transform 300ms ease-in-out; max-width: 500px; width: 100%; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .hidden { display: none !important; }
        #admin-action-overlay { position: absolute; inset: 0; background-color: rgba(255, 255, 255, 0.75); display: flex; justify-content: center; align-items: center; z-index: 20; }
        #admin-action-overlay.hidden { display: none; }
        #admin-action-overlay .spinner { width: 24px; height: 24px; }
        .view-loading::after { content: 'Adatok betöltése...'; display: block; text-align: center; padding: 2rem; color: #6b7280; font-style: italic; }
        .book-button-disabled { cursor: not-allowed; opacity: 0.5; }
        .recurring-indicator-icon { display: inline-block; width: 0.8em; height: 0.8em; margin-left: 3px; vertical-align: -0.1em; fill: currentColor; color: #ca8a04; }
        /* Header elrejtése */
        body.no-header #app-header { display: none; }
        body.no-header #main-content { margin-top: 0; padding-top: 0; }

        /* Teljes képernyős elrendezés */
        html, body { height: 100%; overflow: hidden; }
        body { display: flex; flex-direction: column; }
        #main-content { flex-grow: 1; overflow-y: auto; padding-bottom: 60px; /* Hely a láblécnek */ }
        footer { flex-shrink: 0; }

        /* Idősáv kártya stílusa (Terem nézet) */
        .room-view-card-list .timeslot-box {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
            position: relative;
            border-left-width: 4px; /* Vékony szegély */
            padding-left: 1rem; /* Kisebb behúzás */
            padding-right: 4.5rem; /* Hely a jobb oldali jelzőnek */
            padding-top: 0.75rem; /* p-3 */
            padding-bottom: 0.75rem;
            min-height: 4.5rem;
            display: flex;
            align-items: center;
        }
        /* Aktív idősáv kiemelése (Terem nézet) */
        .room-view-card-list .timeslot-box.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.4);
            border-left-color: #4338ca !important; /* indigo-700 */
            background-color: #e0e7ff; /* indigo-100 */
            z-index: 10;
            min-height: 5rem;
        }
        /* Következő óra kiemelése (Terem nézet) */
        .room-view-card-list .timeslot-box.next-up {
            background-color: #f0f9ff; /* sky-50 */
            border-left-color: #7dd3fc; /* sky-300 */
        }

        /* Jobb oldali állapotjelzők (Terem nézet) */
        .room-view-card-list .status-indicator {
            position: absolute;
            right: 0.75rem; /* px-3 */
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem; /* Extra kicsi */
            font-weight: bold;
            padding: 0.15rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            color: white;
            text-transform: uppercase;
        }
        .room-view-card-list .status-indicator.active { background-color: #16a34a; } /* green-600 */
        .room-view-card-list .status-indicator.next { background-color: #0ea5e9; } /* sky-500 */

        /* Típus jelző (foglaló mellett) */
        .booking-type-badge {
            font-size: 0.75rem; /* text-xs */
            font-weight: 600;
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            background-color: #1f2937; /* gray-800 */
            color: white;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
         /* Napi nézet kártya stílusok (Listás nézet) */
         .daily-summary-list li {
            padding-top: 0.5rem; /* py-2 */
            padding-bottom: 0.5rem;
         }
         .daily-summary-list li.active {
             background-color: #eef2ff; /* indigo-50 */
             font-weight: 600; /* font-semibold */
         }
         /* Heti nézet cella tartalom */
         .weekly-booking-details { cursor: pointer; }
         .weekly-booking-details:hover { background-color: rgba(239, 246, 255, 0.5); } /* blue-50/50 */
         /* Admin hirdetmény sáv */
         #announcement-bar {
             background-color: #fffbeb; /* yellow-50 */
             color: #ca8a04; /* yellow-600 */
             border: 1px solid #fef3c7; /* yellow-200 */
         }
         /* Heti nézet navigációs gomb ikon mérete */
         .week-nav-button svg {
             width: 1.25rem; /* w-5 */
             height: 1.25rem; /* h-5 */
         }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <header id="app-header" class="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-30">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-y-2">
            <div class="flex items-center space-x-3">
                 <img src="logo.png" alt="SZAG Logo" class="h-8 w-8 rounded-full" onerror="this.style.display='none'">
                 <h1 class="text-xl font-bold cursor-pointer" onclick="navigateTo('#/')">SZAG Teremfoglaló</h1>
            </div>
            <nav class="flex items-center space-x-2 sm:space-x-4">
                <div id="nav-links" class="flex items-center space-x-2 sm:space-x-4"></div>
                <div id="user-status" class="flex items-center space-x-2">
                    <span class="text-sm text-indigo-200">Betöltés...</span>
                </div>
            </nav>
        </div>
    </header>

    <div id="announcement-bar" class="hidden container mx-auto mt-2 p-3 text-center text-sm rounded shadow">
        <span id="announcement-message"></span>
    </div>

    <main id="main-content" class="container mx-auto mt-4 pb-16">
        <div id="loading-view" class="flex flex-col justify-center items-center h-64 text-xl text-gray-600">
            <div class="spinner mb-4"></div>
            <p>Alkalmazás betöltése...</p>
        </div>
        <div id="error-view" class="hidden p-4 text-center text-red-700 bg-red-100 rounded-lg"></div>
        <div id="weekly-view" class="hidden view-loading px-4"></div>
        <div id="daily-summary-view" class="hidden view-loading"></div>
        <div id="room-view" class="hidden view-loading"></div>
        <div id="admin-view" class="hidden view-loading px-4"></div>
    </main>

    <div id="login-popup" class="hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-4 shadow-lg z-50 flex justify-center items-center">
        <p id="login-popup-message" class="mr-4">Ehhez a művelethez bejelentkezés szükséges.</p>
        <button id="google-login-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded inline-flex items-center transition duration-150 ease-in-out">
            <svg class="fill-current w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
            <span id="login-button-text">Bejelentkezés iskolai Google-fiókkal</span>
            <svg id="login-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
         <button id="login-popup-close" class="ml-4 text-gray-400 hover:text-white text-2xl leading-none" title="Bezárás">&times;</button>
    </div>

    <div id="booking-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="booking-modal-title" class="text-xl font-bold mb-4 text-indigo-700">Teremfoglalás</h3> <input type="hidden" id="booking-id-to-edit"> <div class="space-y-3 mb-4 text-gray-700">
                <p><span class="font-semibold">Terem:</span> <span id="modal-room-name"></span></p>
                <p><span class="font-semibold">Nap:</span> <span id="modal-day"></span> (<span id="modal-date"></span>)</p>
                <p><span class="font-semibold">Idősáv:</span> <span id="modal-timeslot"></span></p>
            </div>
            <div id="modal-user-selector-div" class="hidden mb-4">
                 <label for="modal-user-selector" class="block text-sm font-medium text-gray-700 mb-1">Foglaló felhasználó:</label>
                 <select id="modal-user-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>
            <div class="mb-4">
                <label for="bookingUser" class="block text-sm font-medium text-gray-700 mb-1">Foglaló neve / Foglalás célja:</label>
                <input type="text" id="bookingUser" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. Nagy Péter / 10.A Informatika óra">
            </div>
             <div class="mb-4">
                <label for="bookingComment" class="block text-sm font-medium text-gray-700 mb-1">Megjegyzés (opcionális):</label>
                <input type="text" id="bookingComment" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. Dolgozatírás">
            </div>
            <div id="modal-recurring-option" class="hidden mb-4">
                <label class="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" id="modal-is-recurring" class="rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                    <span class="text-sm text-gray-700">Rendszeres foglalás (minden héten)</span>
                </label>
                 <p class="text-xs text-gray-500 mt-1">A rendszeres foglalás minden héten ugyanerre a napra és idősávra érvényes.</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-button" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150">Mégse</button>
                <button id="modal-confirm-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 flex items-center">
                    <span id="modal-confirm-text">Foglalás Mentése</span>
                     <svg id="modal-spinner" class="hidden animate-spin ml-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="custom-dialog" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <p id="custom-dialog-message" class="text-gray-700 mb-4 whitespace-pre-wrap"></p>
            <div id="custom-dialog-buttons" class="flex justify-end space-x-3"></div>
        </div>
    </div>

     <div id="booking-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xl font-bold text-indigo-700">Foglalás Részletei</h3>
                 <button id="booking-details-close" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <div id="booking-details-content" class="space-y-2 text-gray-800"></div>
            <div id="booking-details-actions" class="flex justify-end mt-4 space-x-3">
                 </div>
        </div>
    </div>


    <footer class="text-center text-gray-500 text-sm py-4 mt-auto flex items-center justify-center space-x-2">
        <span>Powered by</span>
        <img src="logo.png" alt="Logo" class="h-5 w-5 inline-block" onerror="this.style.display='none'">
        <span>SZAG Teremfoglaló &copy; <span id="current-year"></span></span>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Konfiguráció ---
        const firebaseConfig = {
            apiKey: "AIzaSyAs8pqCdCnyFDRivyUJJPh9nc0R1yNCAys", // <- CSERÉLD LE!
            authDomain: "teremfoglalo-913e0.firebaseapp.com", // <- CSERÉLD LE!
            projectId: "teremfoglalo-913e0", // <- CSERÉLD LE!
            storageBucket: "teremfoglalo-913e0.firebasestorage.app", // <- CSERÉLD LE!
            messagingSenderId: "705982282868", // <- CSERÉLD LE!
            appId: "1:705982282868:web:183b3c35161ee0bffce521" // <- CSERÉLD LE!
        };

        // --- Globális Változók ---
        let firebaseApp;
        let firestore;
        let auth;
        let googleProvider;
        let currentUser = undefined;
        let rooms = [];
        let timeSlots = [];
        let bookings = [];
        let allowedUsers = [];
        let pendingUsers = [];
        let cancellations = [];
        let announcement = "";
        let currentView = 'loading';
        let currentRoomId = null;
        let unsubscribePublicListeners = [];
        let unsubscribeAdminListeners = [];
        const STATIC_DAYS = ['Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek'];
        let currentMonday = getMonday(new Date());
        let initialPublicDataLoaded = false;
        let clockInterval = null;
        let dayCheckInterval = null;
        let authStatePromise = null;

        // --- DOM Elemek Referenciái ---
        const loadingView = document.getElementById('loading-view');
        const errorView = document.getElementById('error-view');
        const weeklyViewDiv = document.getElementById('weekly-view');
        const dailySummaryViewDiv = document.getElementById('daily-summary-view');
        const roomViewDiv = document.getElementById('room-view');
        const adminViewDiv = document.getElementById('admin-view');
        const loginPopup = document.getElementById('login-popup');
        const googleLoginButton = document.getElementById('google-login-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginPopupCloseButton = document.getElementById('login-popup-close');
        const loginPopupMessage = document.getElementById('login-popup-message');
        const userStatusDiv = document.getElementById('user-status');
        const navLinksDiv = document.getElementById('nav-links');
        const mainContent = document.getElementById('main-content');
        const announcementBar = document.getElementById('announcement-bar');
        const announcementMessageSpan = document.getElementById('announcement-message');
        const bookingModalElement = document.getElementById('booking-modal');
        const bookingModalTitle = document.getElementById('booking-modal-title'); // Modal cím
        const bookingIdToEditInput = document.getElementById('booking-id-to-edit'); // Rejtett input
        const modalRoomName = document.getElementById('modal-room-name');
        const modalDay = document.getElementById('modal-day');
        const modalDate = document.getElementById('modal-date');
        const modalTimeslot = document.getElementById('modal-timeslot');
        const modalBookingUserInput = document.getElementById('bookingUser');
        const modalBookingCommentInput = document.getElementById('bookingComment');
        const modalRecurringOptionDiv = document.getElementById('modal-recurring-option');
        const modalIsRecurringCheckbox = document.getElementById('modal-is-recurring');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const modalConfirmText = document.getElementById('modal-confirm-text');
        const modalSpinner = document.getElementById('modal-spinner');
        const modalUserSelectorDiv = document.getElementById('modal-user-selector-div');
        const modalUserSelector = document.getElementById('modal-user-selector');
        const customDialog = document.getElementById('custom-dialog');
        const customDialogMessage = document.getElementById('custom-dialog-message');
        const customDialogButtons = document.getElementById('custom-dialog-buttons');
        const bookingDetailsModal = document.getElementById('booking-details-modal');
        const bookingDetailsContent = document.getElementById('booking-details-content');
        const bookingDetailsActions = document.getElementById('booking-details-actions');
        const bookingDetailsCloseButton = document.getElementById('booking-details-close');


        // --- Dátum Segédfüggvények ---
        function getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function formatDateYYYYMMDD(d) { const year = d.getFullYear(); const month = (d.getMonth() + 1).toString().padStart(2, '0'); const day = d.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; }
        function formatShortDate(d) { return d.toLocaleDateString('hu-HU', { month: 'short', day: 'numeric' }); }
        function formatFullDate(d) { return d.toLocaleDateString('hu-HU', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); }
        function formatTime(d) { return d.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
        function getWeekDates(mondayDate) { const dates = []; for (let i = 0; i < 5; i++) { const date = new Date(mondayDate); date.setDate(mondayDate.getDate() + i); dates.push(date); } return dates; }
        function changeWeek(direction) { const newMonday = new Date(currentMonday); newMonday.setDate(currentMonday.getDate() + (direction * 7)); currentMonday = newMonday; console.log("Changing week to Monday:", formatDateYYYYMMDD(currentMonday)); if (currentView === 'weekly') { renderWeeklyView(); } }
        function getTodayDayName() { const days = ['Vasárnap', 'Hétfő', 'Kedd', 'Szerda', 'Csütörtök', 'Péntek', 'Szombat']; return days[new Date().getDay()]; }
        function getCurrentTimeSlot(timeSlots) { if (!timeSlots || timeSlots.length === 0) return null; const now = new Date(); const hours = now.getHours(); const minutes = now.getMinutes(); const currentTime = hours * 60 + minutes; const sortedSlots = [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0)); for (const slot of sortedSlots) { if (!slot.value || !slot.value.includes(' - ')) continue; try { const [startTime, endTime] = slot.value.split(' - '); const [startHour, startMinute] = startTime.split(':').map(Number); const [endHour, endMinute] = endTime.split(':').map(Number); if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) continue; const slotStart = startHour * 60 + startMinute; const slotEnd = endHour * 60 + endMinute; if (currentTime >= slotStart && currentTime < slotEnd) return slot.value; } catch (e) { console.error("Error parsing time slot:", slot.value, e); continue; } } return null; }
        function getNextTimeSlot(timeSlots) { if (!timeSlots || timeSlots.length === 0) return null; const now = new Date(); const hours = now.getHours(); const minutes = now.getMinutes(); const currentTime = hours * 60 + minutes; const sortedSlots = [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0)); for (const slot of sortedSlots) { if (!slot.value || !slot.value.includes(' - ')) continue; try { const [startTime] = slot.value.split(' - '); const [startHour, startMinute] = startTime.split(':').map(Number); if (isNaN(startHour) || isNaN(startMinute)) continue; const slotStart = startHour * 60 + startMinute; if (slotStart > currentTime) return slot.value; } catch (e) { console.error("Error parsing time slot for next:", slot.value, e); continue; } } return null; }
        function sanitizeName(name) { if (!name) return ''; return name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, ''); }
        function findRoomBySanitizedName(sanitizedName) { if (!sanitizedName) return null; const room = rooms.find(r => sanitizeName(r.name) === sanitizedName); return room ? room.id : null; }

        // --- Inicializálás ---
        function initializeApp() {
            console.log("initializeApp() called");
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error("Firebase konfiguráció hiányzik.");
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firestore = firebase.firestore();
                auth = firebase.auth();
                googleProvider = new firebase.auth.GoogleAuthProvider();
                console.log("Firebase (App, Firestore, Auth) sikeresen inicializálva.");
                setupEventListeners();
                setupPublicFirestoreListeners(); // Nyilvános adatok figyelőinek indítása
                setupAuthListener(); // Auth listener indítása (ez kezeli a user állapotot és a további listenereket)
                document.getElementById('current-year').textContent = new Date().getFullYear();
                startClockAndDayCheck(); // Óra és napváltás figyelő indítása
                console.log("initializeApp() finished successfully.");
            } catch (error) {
                console.error("Firebase inicializálási hiba:", error);
                showError(`Firebase inicializálása sikertelen: ${error.message}.`);
            }
        }

        // --- Nézetváltás ---
        function switchView(viewId, roomId = null) {
            console.log(`Switching view to: ${viewId}`, roomId ? `with roomId: ${roomId}` : '');
            if (viewId === currentView && roomId === currentRoomId && viewId !== 'loading') return;

            currentView = viewId;
            currentRoomId = roomId;

            const shouldHideHeader = ['daily-summary', 'room'].includes(viewId);
            document.body.classList.toggle('no-header', shouldHideHeader);
            document.getElementById('app-header').classList.toggle('hidden', shouldHideHeader);
            mainContent.style.marginTop = shouldHideHeader ? '0' : '';

            [loadingView, errorView, weeklyViewDiv, dailySummaryViewDiv, roomViewDiv, adminViewDiv]
                .forEach(el => el?.classList.add('hidden'));

            const viewElement = document.getElementById(`${viewId}-view`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
                if (initialPublicDataLoaded && !['loading', 'error'].includes(viewId)) {
                    console.log(`Rendering view: ${viewId}`);
                    renderView();
                } else if (['loading', 'error'].includes(viewId)) {
                     console.log(`Displaying special view: ${viewId}`);
                } else {
                     console.log(`View ${viewId} shown, waiting for initial data to render.`);
                     viewElement.classList.add('view-loading');
                }
            } else {
                console.error(`View element not found: ${viewId}-view`);
                showError(`A kért nézet (${viewId}) nem található.`);
            }
            updateNavLinks();
        }

        // --- Útvonal Kezelés ---
        async function handleRouteChange() {
            console.log(">>> handleRouteChange() called");
            const hash = window.location.hash || '#/';
            const params = new URLSearchParams(window.location.search);
            const urlRoomNameParam = params.get('id');
            console.log("Current hash:", hash, "URL param 'id':", urlRoomNameParam);

            // Várjuk meg, amíg az auth state biztosan beállítódik
            if (currentUser === undefined) {
                console.log("Routing skipped: Waiting for auth state...");
                if (authStatePromise) {
                    await authStatePromise;
                    console.log("Auth state promise resolved in handleRouteChange. Current user:", currentUser);
                } else {
                    console.log("Routing skipped: Auth state promise not yet available.");
                    return; // Még nem indult el az auth listener
                }
            }

            if (!initialPublicDataLoaded || currentView === 'error') {
                 console.log("Routing skipped (initial public data not loaded or error state)");
                 return;
            }

            let targetView = '';
            let targetRoomId = null;

            if (urlRoomNameParam) {
                const foundRoomId = findRoomBySanitizedName(urlRoomNameParam);
                if (foundRoomId) {
                    console.log(`Room found by URL param: ${urlRoomNameParam} -> ${foundRoomId}`);
                    targetView = 'room';
                    targetRoomId = foundRoomId;
                     if (window.location.hash !== '#room') {
                        window.location.hash = '#room';
                        return; // hashchange event will re-trigger this
                    }
                } else {
                    console.error(`Room not found for URL param id: ${urlRoomNameParam}`);
                    showError(`A megadott terem (${urlRoomNameParam}) nem található.`);
                    return;
                }
            }
            else if (hash === '#/') targetView = 'weekly';
            else if (hash === '#/view') targetView = 'daily-summary';
            else if (hash.startsWith('#/room')) {
                 console.warn("Navigating to #room via hash without ?id= parameter is not supported. Redirecting to weekly.");
                 targetView = 'weekly';
                 navigateTo('#/');
                 return;
            } else if (hash === '#/admin') {
                if (currentUser?.isAdmin) { // Itt már biztosan tudjuk az admin státuszt
                    targetView = 'admin';
                    // Csak akkor indítjuk az admin listenereket, ha még nem futnak
                    if (unsubscribeAdminListeners.length === 0) {
                        setupAdminFirestoreListeners();
                    }
                } else {
                    console.warn("Admin access denied.");
                    if (!currentUser) { showLoginPopup("Az admin felület megtekintéséhez bejelentkezés szükséges."); }
                    else { showCustomAlert("Nincs jogosultságod az admin felület megtekintéséhez.", "Hiba"); navigateTo('#/'); }
                    return; // Fontos, hogy itt kilépjünk, ne váltson nézetet
                }
            } else {
                targetView = 'weekly';
                if (window.location.hash !== '#/') { console.log("Unknown hash, navigating to #/"); navigateTo('#/'); return; }
            }

            console.log("Routing: Target view determined:", targetView, "Target Room ID:", targetRoomId);
            switchView(targetView, targetRoomId);
        }

        function navigateTo(hash) {
            console.log("Navigating to:", hash);
            const currentUrl = new URL(window.location);
            const targetPath = hash.substring(1);
            if (!targetPath.startsWith('/room')) {
                 currentUrl.searchParams.delete('id');
            }
            const newUrl = currentUrl.pathname + currentUrl.search + hash;
            const oldUrl = window.location.pathname + window.location.search + window.location.hash;

            if (oldUrl !== newUrl) {
                 window.location.href = newUrl; // Ez vált hashchange eseményt
            } else if (currentView !== targetPath.split('?')[0]) {
                 // Ha az URL ugyanaz, de a nézet más (pl. admin jogosultság hiba után), akkor is frissítünk
                 switchView(targetPath.split('?')[0]);
            }
        }

        // --- Hiba Megjelenítés ---
        function showError(message) {
            console.error("Showing error:", message);
            errorView.textContent = `Hiba: ${message}`;
            [loadingView, weeklyViewDiv, dailySummaryViewDiv, roomViewDiv, adminViewDiv]
                .forEach(el => el?.classList.add('hidden'));
            errorView.classList.remove('hidden');
            currentView = 'error';
            initialPublicDataLoaded = true;
        }

        // --- Felhasználói Felület Frissítése ---
        function updateUIBasedOnAuthState(user) {
             console.log("updateUIBasedOnAuthState called with user:", user ? user.uid : null);
            const wasLoggedIn = currentUser !== undefined && currentUser !== null;
            currentUser = user;

            if (user) {
                loginPopup.classList.add('hidden');
                userStatusDiv.innerHTML = `
                    <span class="text-sm hidden lg:inline" title="${escapeHtml(user.email)}">${escapeHtml(user.nickname || user.displayName || user.email)} ${user.isAdmin ? '<span class="text-yellow-300">(Admin)</span>' : ''}</span>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm font-semibold py-1 px-2 sm:px-3 rounded transition duration-150 ease-in-out">
                        Kijelentkezés
                    </button>
                `;
                const logoutBtn = document.getElementById('logout-button');
                if (logoutBtn) {
                    logoutBtn.removeEventListener('click', handleLogout);
                    logoutBtn.addEventListener('click', handleLogout);
                }
                if (user.isAdmin && unsubscribeAdminListeners.length === 0) {
                    setupAdminFirestoreListeners();
                }
                 if (initialPublicDataLoaded) {
                    // Ha az auth state megváltozott, mindig újraértékeljük a routingot/nézetet
                    handleRouteChange();
                 }
                 displayAnnouncement();

            } else { // User is null (logged out)
                 if (currentUser !== undefined) { // Csak akkor frissítsük, ha nem a kezdeti undefined állapot
                    userStatusDiv.innerHTML = `<button id="show-login-button" class="bg-blue-500 hover:bg-blue-700 text-white text-sm font-semibold py-1 px-2 sm:px-3 rounded">Bejelentkezés</button>`;
                    const loginBtn = document.getElementById('show-login-button');
                    if (loginBtn) {
                        loginBtn.removeEventListener('click', () => showLoginPopup());
                        loginBtn.addEventListener('click', () => showLoginPopup());
                    }
                    unsubscribeAdminFirestoreListeners();
                    allowedUsers = [];
                    pendingUsers = [];
                    announcementBar.classList.add('hidden');
                    if (currentView === 'admin') {
                        navigateTo('#/');
                    } else if (initialPublicDataLoaded && currentView !== 'loading' && currentView !== 'error') {
                        renderView(); // Frissítsük a nézetet (gombok letiltása)
                    }
                 }
            }
             updateNavLinks();
        }

        function updateNavLinks() {
            let linksHtml = `
                <button onclick="navigateTo('#/')" class="hover:bg-indigo-700 px-2 py-1 sm:px-3 rounded text-sm sm:text-base ${currentView === 'weekly' ? 'bg-indigo-800 font-semibold' : ''}">Heti nézet</button>
                <button onclick="navigateTo('#/view')" class="hover:bg-indigo-700 px-2 py-1 sm:px-3 rounded text-sm sm:text-base ${currentView === 'daily-summary' ? 'bg-indigo-800 font-semibold' : ''}">Napi összesítő</button>
            `;
            if (currentUser?.isAdmin) {
                linksHtml += `
                    <button onclick="navigateTo('#/admin')" class="hover:bg-purple-700 px-2 py-1 sm:px-3 rounded text-sm sm:text-base ${currentView === 'admin' ? 'bg-purple-800 font-semibold' : 'bg-purple-600'}">Admin</button>
                `;
            }
            navLinksDiv.innerHTML = linksHtml;
        }


        // --- Renderelő Függvények ---
        function renderView() {
            console.log(`Attempting to render view: ${currentView}`);
            if (!initialPublicDataLoaded && currentView !== 'loading' && currentView !== 'error') {
                console.log("Render skipped: initial public data not loaded yet.");
                const viewElement = document.getElementById(`${currentView}-view`);
                viewElement?.classList.add('view-loading');
                return;
            }

            if (!['loading', 'error'].includes(currentView)) {
                loadingView.classList.add('hidden');
                errorView.classList.add('hidden');
            } else { return; }

            const viewElement = document.getElementById(`${currentView}-view`);
            if (!viewElement) {
                 console.error(`Render failed: View element ${currentView}-view not found.`);
                 return;
            }
            viewElement.classList.add('view-loading');

            try {
                switch (currentView) {
                    case 'weekly': renderWeeklyView(); break;
                    case 'daily-summary': renderDailySummaryView(); break;
                    case 'room': renderRoomView(); break;
                    case 'admin':
                        if (currentUser?.isAdmin) renderAdminView();
                        else navigateTo('#/');
                        break;
                    default: navigateTo('#/');
                }
                viewElement.classList.remove('view-loading');
            } catch (error) {
                console.error(`Error rendering view ${currentView}:`, error);
                showError(`Hiba történt a(z) ${currentView} nézet megjelenítésekor: ${error.message}`);
                viewElement.classList.remove('view-loading');
            }
        }

        /** Heti nézet táblázatának generálása és megjelenítése */
        function renderWeeklyView() {
            console.log("Rendering Weekly View for date:", formatDateYYYYMMDD(currentMonday));
            weeklyViewDiv.innerHTML = '';

            const weekDates = getWeekDates(currentMonday);
            const weekDateStrings = weekDates.map(formatDateYYYYMMDD);
            const sortedTimeSlots = [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
            const sortedRooms = [...rooms].sort((a, b) => a.name.localeCompare(b.name));
            const singleBookingsThisWeek = bookings.filter(b => b.date && weekDateStrings.includes(b.date) && b.type === 'single');
            const recurringBookingTemplates = bookings.filter(b => b.type === 'recurring');
            const cancellationsThisWeek = cancellations.filter(c => weekDateStrings.includes(c.date));

            let tableHTML = `
                <div class="flex justify-between items-center mb-4">
                     <button onclick="changeWeek(-1)" class="week-nav-button bg-indigo-500 hover:bg-indigo-700 text-white font-bold p-2 rounded" title="Előző hét">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                     </button>
                    <h2 class="text-lg sm:text-xl font-bold text-center text-gray-800"> Heti Teremfoglalások <br class="sm:hidden"> (${formatShortDate(weekDates[0])} - ${formatShortDate(weekDates[4])})
                    </h2>
                     <button onclick="changeWeek(1)" class="week-nav-button bg-indigo-500 hover:bg-indigo-700 text-white font-bold p-2 rounded" title="Következő hét">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                     </button>
                </div>
                <div class="overflow-x-auto shadow-md rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-100 z-10 border-r">Idő / Nap</th>
                                ${weekDates.map((date, index) => `
                                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap border-l">
                                        ${STATIC_DAYS[index]}<br>(${formatShortDate(date)})
                                    </th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${sortedTimeSlots.map(slot => `
                                <tr class="divide-x divide-gray-100">
                                    <td class="px-3 py-4 whitespace-nowrap font-medium text-gray-900 sticky left-0 bg-white z-10 border-r">${escapeHtml(slot.value)}</td>
                                    ${weekDates.map((date, dayIndex) => {
                                        const dateString = weekDateStrings[dayIndex];
                                        const dayName = STATIC_DAYS[dayIndex];
                                        return `
                                            <td class="px-2 py-2 whitespace-nowrap text-sm text-gray-500 align-top">
                                                <ul class="space-y-1">
                                                    ${sortedRooms.map(room => {
                                                        let booking = singleBookingsThisWeek.find(b => b.roomId === room.id && b.date === dateString && b.timeSlot === slot.value);
                                                        let isRecurringMatch = false;
                                                        let isCancelled = false;
                                                        let recurringBookingId = null;

                                                        if (!booking) {
                                                            const recurringBooking = recurringBookingTemplates.find(b => b.roomId === room.id && b.day === dayName && b.timeSlot === slot.value);
                                                            if (recurringBooking) {
                                                                isCancelled = cancellationsThisWeek.some(c => c.recurringBookingId === recurringBooking.id && c.date === dateString);
                                                                if (!isCancelled) {
                                                                    booking = recurringBooking;
                                                                    isRecurringMatch = true;
                                                                    recurringBookingId = booking.id;
                                                                }
                                                            }
                                                        }

                                                        const isBooked = !!booking;
                                                        const canDelete = currentUser && booking && (currentUser.isAdmin || (currentUser.uid === booking.userId && booking.type === 'single'));
                                                        const canCancelInstance = currentUser && isRecurringMatch && booking.userId === currentUser.uid && !isCancelled;
                                                        const canBook = !isBooked && !isCancelled;
                                                        const displayUser = booking?.user || '';
                                                        const displayComment = booking?.comment || '';
                                                        const fullText = displayUser + (displayComment ? ` (${displayComment})` : '');
                                                        const displayName = fullText; // Teljes név

                                                        return `
                                                            <li class="flex items-center space-x-1.5 text-xs group relative">
                                                                <span class="inline-block w-2.5 h-2.5 rounded-full flex-shrink-0 ${isBooked ? 'bg-red-500' : (isCancelled ? 'bg-gray-400' : 'bg-green-500')}" title="${isBooked ? 'Foglalt' : (isCancelled ? 'Lemondva' : 'Szabad')}"></span>
                                                                <span class="flex-grow overflow-hidden overflow-ellipsis whitespace-nowrap ${isBooked ? 'text-gray-700' : 'text-gray-500'} ${isCancelled ? 'line-through text-gray-400' : ''} weekly-booking-details" ${isBooked ? `onclick="showBookingDetails('${booking.id}', ${isRecurringMatch})"` : ''} title="${isBooked ? escapeHtml(fullText) : (isCancelled ? 'Lemondva' : '')}">
                                                                    ${escapeHtml(room.name)}
                                                                    ${isBooked ? `<span class="${isRecurringMatch ? 'text-yellow-700' : 'text-red-700'} font-medium"> (${displayName}${isRecurringMatch ? `<svg class="recurring-indicator-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3a.75.75 0 01.75.75v1.5h1.5a.75.75 0 010 1.5h-1.5v1.5a.75.75 0 01-1.5 0v-1.5h-1.5a.75.75 0 010-1.5h1.5v-1.5A.75.75 0 018 3z" /><path fill-rule="evenodd" d="M1.75 4.5a.75.75 0 01.75-.75h11a.75.75 0 010 1.5h-11a.75.75 0 01-.75-.75zM1.75 11.5a.75.75 0 01.75-.75h11a.75.75 0 010 1.5h-11a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg>` : ''})</span>` : (isCancelled ? '<span class="text-gray-500 italic">(Lemondva)</span>' : '')}
                                                                </span>
                                                                ${canBook ? `
                                                                    <button
                                                                        onclick="handleBookingClick('${room.id}', '${escapeJsString(room.name)}', '${dayName}', '${escapeJsString(slot.value)}', '${dateString}')"
                                                                        class="ml-auto text-indigo-600 hover:text-indigo-900 text-[10px] font-semibold px-1 py-0.5 rounded hover:bg-indigo-50 opacity-0 group-hover:opacity-100 transition-opacity ${!currentUser ? 'book-button-disabled' : ''}"
                                                                        title="Foglalás: ${escapeHtml(room.name)}, ${dayName} (${dateString}), ${escapeHtml(slot.value)}"
                                                                        ${!currentUser ? 'disabled' : ''}>
                                                                        Foglal
                                                                    </button>
                                                                ` : ''}
                                                                 ${canCancelInstance ? `
                                                                    <button
                                                                        onclick="cancelRecurringInstance('${recurringBookingId}', '${dateString}', '${escapeJsString(room.name)}', '${dayName} (${dateString})', '${escapeJsString(slot.value)}')"
                                                                        class="ml-1 text-orange-600 hover:text-orange-800 text-[10px] font-semibold px-1 py-0.5 rounded hover:bg-orange-50 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        title="Egyszeri lemondás erre a napra">
                                                                        Lemond
                                                                    </button>
                                                                ` : ''}
                                                                ${isBooked && canDelete ? `
                                                                    <button
                                                                        onclick="deleteBooking('${booking.id}', '${escapeJsString(room.name)}', '${dayName} (${dateString})', '${escapeJsString(slot.value)}', '${escapeJsString(booking.user)}', ${isRecurringMatch})"
                                                                        class="ml-1 text-red-500 hover:text-red-800 text-[10px] font-semibold px-1 py-0.5 rounded hover:bg-red-50 opacity-0 group-hover:opacity-100 transition-opacity"
                                                                        title="Foglalás Törlése ${isRecurringMatch ? '(Teljes Rendszeres!)' : ''}">
                                                                        X
                                                                    </button>
                                                                ` : ''}
                                                            </li>
                                                        `;
                                                    }).join('')}
                                                </ul>
                                            </td>
                                        `;
                                    }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            weeklyViewDiv.innerHTML = tableHTML;
        }

        /** Napi összesítő nézet generálása (Listás) */
        function renderDailySummaryView() {
             console.log("Rendering Daily Summary View (List version)...");
             dailySummaryViewDiv.innerHTML = '';

             const today = getTodayDayName();
             const todayDate = new Date();
             const todayDateString = formatDateYYYYMMDD(todayDate);
             const currentTimeSlotValue = getCurrentTimeSlot(timeSlots);
             const todayCancellations = cancellations.filter(c => c.date === todayDateString);

             const todayBookingsMap = new Map();
             const sortedTimeSlots = [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
             const sortedRooms = [...rooms].sort((a, b) => a.name.localeCompare(b.name));

             sortedRooms.forEach(room => {
                 sortedTimeSlots.forEach(slot => {
                     let booking = bookings.find(b => b.roomId === room.id && b.date === todayDateString && b.timeSlot === slot.value && b.type === 'single');
                     let isCancelled = false;
                     if (!booking) {
                         const recurringBooking = bookings.find(b => b.roomId === room.id && b.day === today && b.timeSlot === slot.value && b.type === 'recurring');
                         if (recurringBooking) {
                             isCancelled = todayCancellations.some(c => c.recurringBookingId === recurringBooking.id);
                             if (!isCancelled) {
                                 booking = recurringBooking;
                             }
                         }
                     }
                     if (booking || isCancelled) {
                         todayBookingsMap.set(`${room.id}-${slot.value}`, { booking: booking, isCancelled: isCancelled });
                     }
                 });
             });

            let summaryHTML = `
                <div class="sticky top-0 bg-gray-100 pt-4 pb-2 px-4 z-10 border-b mb-4">
                     <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-gray-700">${formatFullDate(todayDate)}</span>
                        <span id="current-time-display" class="text-lg font-semibold text-gray-700">${formatTime(new Date())}</span>
                    </div>
                    <h2 class="text-2xl font-bold text-center text-indigo-700 mb-2">Terembeosztás</h2>
                </div>
            `;

            if (sortedRooms.length === 0 || sortedTimeSlots.length === 0) {
                summaryHTML += `<p class="text-center text-gray-500 mt-8 px-4">Nincsenek termek vagy idősávok definiálva.</p>`;
            } else if (todayBookingsMap.size === 0 && !timeSlots.some(slot => slot.value === currentTimeSlotValue)) {
                 summaryHTML += `<p class="text-center text-gray-500 mt-8 px-4">Ma nincs tanítás vagy foglalás.</p>`;
            }
            else {
                summaryHTML += `<div class="space-y-4 px-4 daily-summary-list">`;
                sortedRooms.forEach(room => {
                    const roomHasData = sortedTimeSlots.some(slot => todayBookingsMap.has(`${room.id}-${slot.value}`) || slot.value === currentTimeSlotValue);

                    if (roomHasData) {
                        summaryHTML += `
                            <div class="bg-white p-4 rounded-lg shadow">
                                <h3 class="text-lg font-semibold mb-2 text-indigo-700">${escapeHtml(room.name)}</h3>
                                <ul class="divide-y divide-gray-200">`;

                        sortedTimeSlots.forEach((slot, index) => {
                            const bookingData = todayBookingsMap.get(`${room.id}-${slot.value}`);
                            const booking = bookingData?.booking;
                            const isCancelled = bookingData?.isCancelled ?? false;
                            const isActive = slot.value === currentTimeSlotValue;
                            const isBooked = !!booking;
                            const displayUser = booking?.user || (isCancelled ? 'Lemondva' : 'Szabad');
                            const displayComment = booking?.comment || '';

                            summaryHTML += `
                                <li class="timeslot-box py-2 flex justify-between items-center ${isActive ? 'active bg-indigo-50 font-semibold' : ''} ${isCancelled ? 'opacity-60' : ''}" data-timeslot="${escapeHtml(slot.value)}">
                                    <div class="flex-grow"> <span class="font-medium text-gray-800">${escapeHtml(slot.value)}</span>
                                        <span class="ml-2 ${isBooked ? 'text-gray-600' : 'text-green-600'} ${isCancelled ? '!text-gray-400 italic' : ''}"> - ${escapeHtml(displayUser)}</span>
                                        ${displayComment ? `<span class="ml-2 text-gray-500 italic">(${escapeHtml(displayComment)})</span>` : ''}
                                        ${isBooked ? `<span class="booking-type-badge">${booking.type === 'recurring' ? 'Rendszeres' : 'Egyszeri'}</span>` : ''}
                                    </div>
                                    ${isActive ? `<span class="status-indicator active !relative !top-auto !right-auto !transform-none ml-2">MOST</span>` : ''} </li>
                            `;
                        });
                        summaryHTML += `</ul></div>`;
                    }
                });
                summaryHTML += `</div>`;
            }
            dailySummaryViewDiv.innerHTML = summaryHTML;
        }

        /** Adott szoba napi nézetének generálása (Átalakított stílus) */
        function renderRoomView() {
            if (!currentRoomId) return showError("Nincs kiválasztott szoba ID.");
            const room = rooms.find(r => r.id === currentRoomId);
            if (!room) return showError(`A(z) ${currentRoomId} ID-jű szoba nem található.`);

            console.log(`Rendering Room View for: ${room.name}`);
            roomViewDiv.innerHTML = '';

            const today = getTodayDayName();
            const todayDate = new Date();
            const todayDateString = formatDateYYYYMMDD(todayDate);
            const sortedTimeSlots = [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0));
            const currentTimeSlotValue = getCurrentTimeSlot(timeSlots);
            const nextTimeSlotValue = !currentTimeSlotValue ? getNextTimeSlot(timeSlots) : null;
            const todayCancellations = cancellations.filter(c => c.date === todayDateString);

            const roomBookingsTodayMap = new Map();
            sortedTimeSlots.forEach(slot => {
                let booking = bookings.find(b => b.roomId === room.id && b.date === todayDateString && b.timeSlot === slot.value && b.type === 'single');
                let isCancelled = false;
                if (!booking) {
                    const recurringBooking = bookings.find(b => b.roomId === room.id && b.day === today && b.timeSlot === slot.value && b.type === 'recurring');
                    if (recurringBooking) {
                        isCancelled = todayCancellations.some(c => c.recurringBookingId === recurringBooking.id);
                        if (!isCancelled) {
                            booking = recurringBooking;
                        }
                    }
                }
                 if (booking || isCancelled) {
                    roomBookingsTodayMap.set(slot.value, { booking: booking, isCancelled: isCancelled });
                 }
            });

            let roomHTML = `
                 <div class="sticky top-0 bg-gray-100 pt-4 pb-2 px-4 z-10 border-b mb-4">
                     <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-gray-700">${formatFullDate(todayDate)}</span>
                        <span id="current-time-display-room" class="text-lg font-semibold text-gray-700">${formatTime(new Date())}</span>
                    </div>
                    <h2 class="text-3xl md:text-4xl font-bold text-center text-indigo-700">${escapeHtml(room.name)}</h2>
                 </div>
            `;

            if (sortedTimeSlots.length === 0) {
                 roomHTML += `<p class="text-center text-gray-500 mt-10 text-lg px-4">Nincsenek elérhető idősávok definiálva ehhez a teremhez.</p>`;
            } else {
                // Szélesebb konténer
                roomHTML += `<div class="max-w-2xl mx-auto px-1 sm:px-2"><ul class="space-y-2 room-view-card-list">`;
                let hasAnyBookingOrCurrentSlot = false;
                sortedTimeSlots.forEach((slot, index) => {
                     const bookingData = roomBookingsTodayMap.get(slot.value);
                     const booking = bookingData?.booking;
                     const isCancelled = bookingData?.isCancelled ?? false;
                     const isActive = slot.value === currentTimeSlotValue;
                     const isNext = slot.value === nextTimeSlotValue;
                     if (booking || isActive || isNext || isCancelled) hasAnyBookingOrCurrentSlot = true;

                     const isBooked = !!booking;
                     const typeText = isBooked ? (booking.type === 'recurring' ? 'Rendszeres' : 'Egyszeri') : '';
                     const userText = isBooked ? escapeHtml(booking.user) : (isCancelled ? 'LEMONDVA' : 'SZABAD');
                     const commentText = isBooked ? escapeHtml(booking.comment || '') : '';

                     // Osztályok összeállítása
                     let liClasses = `timeslot-box border-l-4 ${isBooked ? 'border-red-500' : (isCancelled ? 'border-gray-400' : 'border-green-500')} bg-white p-4 rounded-lg shadow-md relative`; // Vékony szegély, p-4 padding
                     if (isActive) {
                         liClasses += ' active bg-indigo-100 border-indigo-700';
                     } else if (isNext) {
                         liClasses += ' next-up bg-sky-50 border-sky-300';
                     }
                     if (isCancelled) {
                         liClasses += ' opacity-70';
                     }

                     roomHTML += `
                        <li class="${liClasses}" data-timeslot="${escapeHtml(slot.value)}">
                             <div class="flex-grow flex flex-col justify-center">
                                <div class="flex justify-between items-center mb-1 relative">
                                    <span class="font-semibold text-gray-800 text-lg">${escapeHtml(slot.value)}</span>
                                    ${isActive ? `<span class="status-indicator active">MOST</span>` : ''}
                                    ${isNext ? `<span class="status-indicator next">KÖVETKEZIK</span>` : ''}
                                </div>
                                <div class="text-gray-700 text-base">
                                    ${userText}
                                    ${isBooked ? `<span class="booking-type-badge">${typeText}</span>` : ''}
                                </div>
                                ${commentText ? `<div class="text-gray-500 text-sm italic mt-1">${commentText}</div>` : ''}
                             </div>
                        </li>
                     `;
                });
                roomHTML += `</ul></div>`;

                if (sortedTimeSlots.length > 0 && !hasAnyBookingOrCurrentSlot) {
                     roomHTML += `<p class="text-center text-gray-500 mt-10 text-lg px-4">Ma nincs tanítás vagy foglalás ebben a teremben.</p>`;
                }
            }
            roomViewDiv.innerHTML = roomHTML;
        }

        /** Adminisztrációs felület generálása */
        function renderAdminView() {
            if (currentUser === undefined) {
                 console.log("Admin view render skipped: currentUser is undefined.");
                 adminViewDiv.innerHTML = '<div class="p-4 text-center text-gray-500">Admin adatok betöltése...</div>';
                 return;
            }
            if (!currentUser?.isAdmin) return navigateTo('#/');
            console.log("Rendering Admin View...");
            adminViewDiv.innerHTML = '';
            const nextOrder = timeSlots.length > 0 ? Math.max(0, ...timeSlots.map(ts => ts.order ?? 0)) + 1 : 0;
            let adminHTML = `
                <div class="p-4 md:p-6 bg-white rounded-lg shadow space-y-8 relative">
                     <div id="admin-action-overlay" class="hidden"><div class="spinner"></div> <span class="ml-3 text-gray-700">Folyamatban...</span></div>
                    <h2 class="text-2xl font-bold text-center text-indigo-700">Adminisztrációs Felület</h2>
                    <section>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Hirdetmény/Üzenet a Főoldalra</h3>
                        <textarea id="admin-announcement" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Írj ide egy rövid üzenetet... (üresen hagyva törlődik)">${escapeHtml(announcement)}</textarea>
                        <div class="text-right mt-2">
                             <button id="save-announcement-button" data-action="save-announcement" class="admin-action-button px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150">Üzenet Mentése</button>
                        </div>
                    </section>
                    <section>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Termek Kezelése</h3>
                        <ul id="admin-rooms-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto border rounded p-2">${rooms.length === 0 ? '<li class="text-gray-500 italic">Nincsenek termek.</li>' : [...rooms].sort((a, b) => a.name.localeCompare(b.name)).map(room => `<li data-id="${room.id}" class="flex justify-between items-center p-2 border-b last:border-b-0"><span>${escapeHtml(room.name)}</span><button data-action="delete-room" class="admin-action-button text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 rounded hover:bg-red-50">Törlés</button></li>`).join('')}</ul>
                        <div class="flex items-end space-x-2"><div class="flex-grow"><label for="newRoomName" class="block text-sm font-medium text-gray-700 mb-1">Új terem neve:</label><input type="text" id="newRoomName" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. Fizika Szertár"></div><button id="add-room-button" data-action="add-room" class="admin-action-button px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 h-10">Hozzáad</button></div>
                    </section>
                    <section>
                         <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Idősávok Kezelése</h3>
                         <ul id="admin-timeslots-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto border rounded p-2">${timeSlots.length === 0 ? '<li class="text-gray-500 italic">Nincsenek idősávok.</li>' : [...timeSlots].sort((a, b) => (a.order ?? 0) - (b.order ?? 0)).map(slot => `<li data-id="${slot.id}" class="flex justify-between items-center p-2 border-b last:border-b-0"><span>${escapeHtml(slot.value)} (Sorrend: ${slot.order ?? 'N/A'})</span><button data-action="delete-timeslot" class="admin-action-button text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 rounded hover:bg-red-50">Törlés</button></li>`).join('')}</ul>
                         <div class="flex items-end space-x-2"><div class="flex-grow"><label for="newTimeSlotValue" class="block text-sm font-medium text-gray-700 mb-1">Új idősáv (óó:pp - óó:pp):</label><input type="text" id="newTimeSlotValue" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. 16:00 - 16:45"></div><div class="w-20"><label for="newTimeSlotOrder" class="block text-sm font-medium text-gray-700 mb-1">Sorrend:</label><input type="number" id="newTimeSlotOrder" value="${nextOrder}" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="0" min="0"></div><button id="add-timeslot-button" data-action="add-timeslot" class="admin-action-button px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 h-10">Hozzáad</button></div>
                    </section>
                    <section>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Engedélyezett Felhasználók (Aktív)</h3>
                        <ul id="admin-users-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto border rounded p-2">${allowedUsers.length === 0 ? '<li class="text-gray-500 italic">Nincsenek engedélyezett felhasználók.</li>' : allowedUsers.map(allowedUser => `<li data-id="${allowedUser.id}" data-email="${escapeHtml(allowedUser.email)}" data-isadmin="${allowedUser.isAdmin}" data-nickname="${escapeHtml(allowedUser.nickname || '')}" class="flex flex-wrap justify-between items-center p-2 border-b last:border-b-0 gap-2"><div class="flex-grow"><span class="text-sm font-medium">${escapeHtml(allowedUser.nickname || allowedUser.email || 'N/A')}</span>${allowedUser.nickname ? `<span class="text-xs text-gray-500 block">(${escapeHtml(allowedUser.email || 'N/A')})</span>` : ''}<span class="text-xs text-gray-500 block break-all">UID: ${allowedUser.id}</span></div><div class="flex space-x-2 flex-shrink-0 items-center">${allowedUser.isAdmin ? '<span class="font-bold text-purple-700 text-xs mr-2">(Admin)</span>' : ''}<button data-action="edit-user" class="admin-action-button text-xs px-2 py-1 rounded bg-gray-500 hover:bg-gray-600 text-white">Név Szerk.</button><button data-action="toggle-admin" class="admin-action-button text-xs px-2 py-1 rounded ${allowedUser.isAdmin ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-500 hover:bg-blue-600'} text-white ${allowedUser.id === currentUser.uid ? 'opacity-50 cursor-not-allowed' : ''}" ${allowedUser.id === currentUser.uid ? 'disabled' : ''}>${allowedUser.isAdmin ? 'Admin Elvétel' : 'Admin Adás'}</button><button data-action="delete-user" class="admin-action-button text-red-600 hover:text-red-800 text-xs font-semibold px-2 py-1 rounded hover:bg-red-50 ${allowedUser.id === currentUser.uid ? 'opacity-50 cursor-not-allowed' : ''}" ${allowedUser.id === currentUser.uid ? 'disabled' : ''}>Eltávolít</button></div></li>`).join('')}</ul>
                    </section>
                    <section>
                        <h3 class="text-xl font-semibold mb-3 text-gray-800 border-b pb-2">Meghívott Felhasználók (Email Alapú)</h3>
                        <ul id="admin-pending-users-list" class="space-y-2 mb-4 max-h-60 overflow-y-auto border rounded p-2">
                            ${pendingUsers.length === 0 ? '<li class="text-gray-500 italic">Nincsenek meghívott felhasználók.</li>' :
                                pendingUsers.map(pending => `
                                <li data-email="${escapeHtml(pending.id)}" data-isadmin="${pending.isAdmin}" data-nickname="${escapeHtml(pending.nickname || '')}" class="flex flex-wrap justify-between items-center p-2 border-b last:border-b-0 gap-2">
                                    <div class="flex-grow">
                                        <span class="text-sm font-medium">${escapeHtml(pending.nickname || pending.id)}</span>
                                        ${pending.nickname ? `<span class="text-xs text-gray-500 block">(${escapeHtml(pending.id)})</span>` : ''}
                                    </div>
                                    <div class="flex space-x-2 flex-shrink-0 items-center">
                                        ${pending.isAdmin ? '<span class="font-bold text-purple-700 text-xs mr-2">(Adminnak meghívva)</span>' : '<span class="text-xs text-gray-500 mr-2">(Felhasználónak meghívva)</span>'}
                                        <button data-action="edit-pending" class="admin-action-button text-xs px-2 py-1 rounded bg-gray-500 hover:bg-gray-600 text-white">Szerkeszt</button>
                                        <button data-action="delete-pending" class="admin-action-button text-red-600 hover:text-red-800 text-xs font-semibold px-2 py-1 rounded hover:bg-red-50">Meghívás Törlése</button>
                                    </div>
                                </li>`).join('')
                            }
                        </ul>
                        <div class="flex flex-col sm:flex-row items-end space-y-2 sm:space-y-0 sm:space-x-2 border-t pt-4">
                            <div class="flex-grow w-full sm:w-1/3">
                                <label for="newPendingUserEmail" class="block text-sm font-medium text-gray-700 mb-1">Új felhasználó Email címe:</label>
                                <input type="email" id="newPendingUserEmail" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="user@example.com">
                            </div>
                             <div class="flex-grow w-full sm:w-1/3">
                                <label for="newPendingUserNickname" class="block text-sm font-medium text-gray-700 mb-1">Megj. név/Becenév (opc.):</label>
                                <input type="text" id="newPendingUserNickname" class="admin-input w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Pl. Kovács János">
                            </div>
                            <div class="flex items-center h-10 pt-2 sm:pt-0">
                                <input type="checkbox" id="newPendingUserIsAdmin" class="admin-input mr-2 rounded border-gray-300 text-indigo-600 shadow-sm focus:ring-indigo-500">
                                <label for="newPendingUserIsAdmin" class="text-sm font-medium text-gray-700">Legyen Admin?</label>
                            </div>
                            <button id="add-pending-user-button" data-action="add-pending" class="admin-action-button px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-150 h-10 w-full sm:w-auto">Meghívás</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">A felhasználó az első bejelentkezése után kapja meg a jogosultságot.</p>
                    </section>
                </div>
            `;
            adminViewDiv.innerHTML = adminHTML;
            adminViewDiv.removeEventListener('click', handleAdminActions);
            adminViewDiv.addEventListener('click', handleAdminActions);
        }

        // --- Segédfüggvények ---
        function escapeHtml(unsafe) { return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ''; }
        function escapeJsString(unsafe) { return unsafe ? unsafe.toString().replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n') : '';}


        // --- Firebase Hitelesítés ---
        function setupAuthListener() {
             console.log("setupAuthListener() called");
             if (!auth) return showError("Auth szolgáltatás nem inicializálódott.");
             authStatePromise = new Promise((resolve) => {
                 const unsubscribe = auth.onAuthStateChanged(async (user) => {
                     console.log(">>> onAuthStateChanged triggered. User:", user ? user.uid : 'null');
                    let resolvedUser = null;
                    if (user) {
                        console.log("User signed in, checking authorization for UID:", user.uid);
                        const userDocRef = firestore.collection('allowedUsers').doc(user.uid);
                        try {
                            console.log("Attempting to get user document from allowedUsers...");
                            const userDoc = await userDocRef.get();
                            if (userDoc.exists) {
                                console.log("User found in allowedUsers. Data:", userDoc.data());
                                const userData = userDoc.data();
                                resolvedUser = { uid: user.uid, displayName: user.displayName, email: user.email, isAdmin: userData.isAdmin || false, nickname: userData.nickname || null };
                            } else {
                                console.log("User not in allowedUsers, checking pendingUsers for email:", user.email.toLowerCase());
                                const pendingUserDocRef = firestore.collection('pendingUsers').doc(user.email.toLowerCase());
                                const pendingDoc = await pendingUserDocRef.get();
                                if (pendingDoc.exists) {
                                    console.log("User found in pendingUsers. Data:", pendingDoc.data());
                                    const pendingData = pendingDoc.data();
                                    resolvedUser = { uid: user.uid, displayName: user.displayName, email: user.email, isAdmin: pendingData.isAdmin || false, nickname: pendingData.nickname || null };
                                    const batch = firestore.batch();
                                    batch.set(userDocRef, { email: user.email.toLowerCase(), isAdmin: resolvedUser.isAdmin, nickname: resolvedUser.nickname });
                                    batch.delete(pendingUserDocRef);
                                    console.log("Attempting to commit batch: add to allowedUsers, delete from pendingUsers");
                                    await batch.commit();
                                    console.log("User successfully migrated from pending to allowed.");
                                } else {
                                    console.warn("User not found in pendingUsers either. Access denied:", user.email);
                                    showCustomAlert(`Hozzáférés megtagadva ehhez az email címhez: ${user.email}. Kérj meghívót egy adminisztrátortól.`, "Hiba");
                                    await auth.signOut();
                                    resolvedUser = null;
                                }
                            }
                        } catch (error) {
                            console.error("Error checking user authorization:", error);
                            showError("Hiba történt a felhasználói jogosultság ellenőrzésekor.");
                            await auth.signOut().catch(e => console.error("Sign out failed:", e));
                            resolvedUser = null;
                        }
                    } else {
                        console.log("User signed out.");
                        resolvedUser = null;
                    }
                    updateUIBasedOnAuthState(resolvedUser);
                    resolve(); // Promise feloldása
                }, (error) => {
                     console.error("Error in onAuthStateChanged listener:", error);
                     showError("Hiba történt a bejelentkezési állapot figyelésekor.");
                     updateUIBasedOnAuthState(null);
                     resolve();
                });
             });
        }

        function handleGoogleLogin() {
            if (!auth || !googleProvider) return showError("Auth szolgáltatás nem inicializálódott.");
            googleLoginButton.disabled = true;
            loginSpinner.classList.remove('hidden');
            loginButtonText.textContent = 'Bejelentkezés...';
            auth.signInWithPopup(googleProvider)
                .catch((error) => {
                    console.error("Google Sign-In Error:", error);
                     if (error.code !== 'auth/popup-closed-by-user' && error.code !== 'auth/cancelled-popup-request') {
                        showCustomAlert(`Hiba a Google bejelentkezés során: ${error.message}`, "Hiba");
                    }
                })
                .finally(() => {
                     if (loginPopup && !loginPopup.classList.contains('hidden')) {
                         googleLoginButton.disabled = false;
                         loginSpinner.classList.add('hidden');
                         loginButtonText.textContent = 'Bejelentkezés iskolai Google-fiókkal';
                     }
                });
        }

        function handleLogout() {
              if (!auth) return;
             console.log("Logging out...");
             auth.signOut().catch((error) => {
                console.error("Logout failed:", error);
                showCustomAlert("Hiba történt a kijelentkezés során.", "Hiba");
             });
        }


        // --- Firestore Listenerek ---
        function setupPublicFirestoreListeners() {
             if (!firestore) { console.log("Skipping public Firestore listeners: no firestore."); return; }
             if (unsubscribePublicListeners.length > 0) { console.log("Public listeners already running."); return; }

            console.log("Setting up PUBLIC Firestore listeners...");
            unsubscribePublicListeners = [];
            initialPublicDataLoaded = false;
            let listenersPending = 4; // rooms, timeSlots, bookings, announcement, cancellations

            function checkInitialLoadComplete() {
                listenersPending--;
                console.log(`Listener responded. Pending: ${listenersPending}`);
                if (listenersPending <= 0 && !initialPublicDataLoaded) {
                    console.log("All initial PUBLIC Firestore data loaded or errored.");
                    initialPublicDataLoaded = true;
                    loadingView.classList.add('hidden');
                    handleRouteChange(); // Kezdeti útvonal beállítása
                }
            }

            try {
                const roomsRef = firestore.collection('rooms').orderBy('name');
                const unsubRooms = roomsRef.onSnapshot((snapshot) => { rooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Public Rooms updated:", rooms.length); checkInitialLoadComplete(); if (initialPublicDataLoaded) renderView(); }, (error) => { console.error("Error fetching public rooms:", error); showError("Hiba a termek betöltésekor."); checkInitialLoadComplete(); });
                unsubscribePublicListeners.push(unsubRooms);

                const timeSlotsRef = firestore.collection('timeSlots').orderBy('order', 'asc');
                 const unsubTimeSlots = timeSlotsRef.onSnapshot((snapshot) => { timeSlots = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Public Time slots updated:", timeSlots.length); checkInitialLoadComplete(); if (initialPublicDataLoaded) renderView(); }, (error) => { console.error("Error fetching public time slots:", error); showError("Hiba az idősávok betöltésekor."); checkInitialLoadComplete(); });
                unsubscribePublicListeners.push(unsubTimeSlots);

                const bookingsRef = firestore.collection('bookings');
                 const unsubBookings = bookingsRef.onSnapshot((snapshot) => { bookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Public Bookings updated:", bookings.length); checkInitialLoadComplete(); if (initialPublicDataLoaded) renderView(); }, (error) => { console.error("Error fetching public bookings:", error); showError("Hiba a foglalások betöltésekor."); checkInitialLoadComplete(); });
                unsubscribePublicListeners.push(unsubBookings);

                 const cancellationsRef = firestore.collection('cancellations');
                 const unsubCancellations = cancellationsRef.onSnapshot((snapshot) => { cancellations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Public Cancellations updated:", cancellations.length); checkInitialLoadComplete(); if (initialPublicDataLoaded) renderView(); }, (error) => { console.error("Error fetching cancellations:", error); checkInitialLoadComplete(); });
                 unsubscribePublicListeners.push(unsubCancellations);

                 const announcementRef = firestore.collection('config').doc('announcement');
                 const unsubAnnouncement = announcementRef.onSnapshot((doc) => { announcement = doc.exists ? (doc.data().message || "") : ""; console.log("Announcement updated:", announcement); checkInitialLoadComplete(); if (initialPublicDataLoaded) displayAnnouncement(); }, (error) => { console.error("Error fetching announcement:", error); announcement = ""; checkInitialLoadComplete(); if (initialPublicDataLoaded) displayAnnouncement(); });
                 unsubscribePublicListeners.push(unsubAnnouncement);

            } catch (error) {
                 console.error("Error setting up public Firestore listeners:", error);
                 showError("Hiba az adatbázis figyelőinek beállításakor.");
                 listenersPending = 0;
                 checkInitialLoadComplete();
            }
        }

        function setupAdminFirestoreListeners() {
             if (!firestore || !currentUser?.isAdmin) { console.log("Skipping admin Firestore listeners: no firestore or not admin."); return; }
             if (unsubscribeAdminListeners.length > 0) { console.log("Admin listeners already running."); return; }
             console.log("Setting up ADMIN Firestore listeners...");
             unsubscribeAdminFirestoreListeners();

             const allowedUsersRef = firestore.collection('allowedUsers').orderBy('email');
             const unsubAllowedUsers = allowedUsersRef.onSnapshot((snapshot) => { allowedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Allowed users updated:", allowedUsers.length); if (initialPublicDataLoaded && currentView === 'admin') renderAdminView(); }, (error) => { console.error("Error fetching allowed users:", error); });
             unsubscribeAdminListeners.push(unsubAllowedUsers);

             const pendingUsersRef = firestore.collection('pendingUsers');
             const unsubPendingUsers = pendingUsersRef.onSnapshot((snapshot) => { pendingUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); console.log("Pending users updated:", pendingUsers.length); if (initialPublicDataLoaded && currentView === 'admin') renderAdminView(); }, (error) => { console.error("Error fetching pending users:", error); });
             unsubscribeAdminListeners.push(unsubPendingUsers);
        }

        function unsubscribeFirestoreListeners() {
            console.log(`Unsubscribing ${unsubscribePublicListeners.length} public and ${unsubscribeAdminListeners.length} admin listeners.`);
            [...unsubscribePublicListeners, ...unsubscribeAdminListeners].forEach(unsub => unsub());
            unsubscribePublicListeners = [];
            unsubscribeAdminListeners = [];
        }
        function unsubscribeAdminFirestoreListeners() {
            console.log(`Unsubscribing ${unsubscribeAdminListeners.length} admin listeners.`);
            unsubscribeAdminListeners.forEach(unsub => unsub());
            unsubscribeAdminListeners = [];
        }


        // --- Foglalási Modal Műveletek ---
        let bookingDataForModal = {};
        function openBookingModal(roomId, roomName, day, timeSlot, dateString, bookingToEdit = null) {
             if (!currentUser) { showLoginPopup("A foglaláshoz be kell jelentkezni."); return; }

             const isEditing = !!bookingToEdit;
             bookingDataForModal = { roomId, day, timeSlot, date: dateString, id: isEditing ? bookingToEdit.id : null };

             // Modal cím és gomb szöveg beállítása
             bookingModalTitle.textContent = isEditing ? "Foglalás Szerkesztése" : "Teremfoglalás";
             modalConfirmText.textContent = isEditing ? "Módosítás Mentése" : "Foglalás Mentése";
             bookingIdToEditInput.value = isEditing ? bookingToEdit.id : ''; // Szerkesztett ID tárolása

             modalRoomName.textContent = roomName;
             modalDay.textContent = day;
             modalDate.textContent = formatShortDate(new Date(dateString + 'T00:00:00'));
             modalTimeslot.textContent = timeSlot;

             // Név/Cél és Megjegyzés előtöltése (szerkesztéskor vagy új foglaláskor)
             if (isEditing) {
                 modalBookingUserInput.value = bookingToEdit.user || '';
                 modalBookingCommentInput.value = bookingToEdit.comment || '';
                 modalIsRecurringCheckbox.checked = bookingToEdit.type === 'recurring';
                 // Szerkesztéskor a típust és a felhasználót nem engedjük módosítani (kivéve admin a nevet)
                 modalIsRecurringCheckbox.disabled = true;
                 modalUserSelectorDiv.classList.add('hidden'); // User választó elrejtése szerkesztéskor
                 // Normál user ne módosíthassa a nevet/célt szerkesztéskor sem
                 modalBookingUserInput.disabled = !currentUser.isAdmin;
             } else {
                 modalBookingUserInput.value = currentUser.nickname || currentUser.displayName || ''; // Új foglalásnál alapértelmezett név
                 modalBookingCommentInput.value = '';
                 modalIsRecurringCheckbox.checked = false;
                 modalIsRecurringCheckbox.disabled = !currentUser.isAdmin; // Csak admin jelölheti be
                 modalBookingUserInput.disabled = false; // Új foglalásnál szerkeszthető (adminnak is)

                 // Admin user selector megjelenítése ÚJ foglaláskor, ha admin
                 if (currentUser.isAdmin) {
                     modalUserSelectorDiv.classList.remove('hidden');
                     modalUserSelector.innerHTML = '';
                     const adminOption = document.createElement('option');
                     adminOption.value = currentUser.uid;
                     adminOption.textContent = `${currentUser.nickname || currentUser.displayName} (Én)`;
                     adminOption.selected = true;
                     modalUserSelector.appendChild(adminOption);
                     allowedUsers.filter(u => u.email).sort((a,b) => (a.nickname || a.email).localeCompare(b.nickname || b.email)).forEach(user => {
                         if (user.id !== currentUser.uid) {
                             const option = document.createElement('option');
                             option.value = user.id;
                             option.textContent = user.nickname || user.email;
                             modalUserSelector.appendChild(option);
                         }
                     });
                     modalUserSelector.onchange = () => {
                         const selectedOption = modalUserSelector.options[modalUserSelector.selectedIndex];
                         const selectedUser = allowedUsers.find(u => u.id === selectedOption.value);
                         modalBookingUserInput.value = selectedUser?.nickname || selectedUser?.displayName || selectedUser?.email || '';
                     };
                 } else {
                     modalUserSelectorDiv.classList.add('hidden');
                 }
             }

             modalRecurringOptionDiv.classList.toggle('hidden', !currentUser.isAdmin); // Rendszeres opció csak adminnak

             bookingModalElement.classList.add('active');
             requestAnimationFrame(() => { bookingModalElement.querySelector('.modal-content').classList.add('modal-enter-active'); });
        }
        function closeBookingModal() {
             const content = bookingModalElement.querySelector('.modal-content');
             content.classList.remove('modal-enter-active');
             content.classList.add('modal-leave-active');
             setTimeout(() => {
                bookingModalElement.classList.remove('active');
                content.classList.remove('modal-leave-active');
                bookingIdToEditInput.value = ''; // Ürítjük a szerkesztési ID-t bezáráskor
             }, 300);
        }
        async function confirmBooking() {
            if (!currentUser || !firestore) return showError("Nincs bejelentkezett felhasználó vagy adatbázis kapcsolat.");
            const bookingIdToEdit = bookingIdToEditInput.value;
            const isEditing = !!bookingIdToEdit;

            const bookingPurpose = modalBookingUserInput.value.trim();
            const bookingComment = modalBookingCommentInput.value.trim();
            if (!bookingPurpose && !isEditing) return showCustomAlert("Kérlek add meg a foglaló nevét vagy a foglalás célját!"); // Csak új foglalásnál kötelező

            const isRecurring = modalIsRecurringCheckbox.checked && currentUser.isAdmin;

            let targetUserId = currentUser.uid;
            let targetUserName = bookingPurpose;

            // Csak ÚJ foglalásnál és ha ADMIN, akkor lehet más usert választani
            if (!isEditing && currentUser.isAdmin && modalUserSelector.value !== currentUser.uid) {
                targetUserId = modalUserSelector.value;
                console.log(`Admin booking for user: ${targetUserId} with name/purpose: ${targetUserName}`);
            } else if (!isEditing) { // Új foglalás, de nem admin vagy saját magának
                 targetUserId = currentUser.uid;
                 if (!targetUserName) targetUserName = currentUser.nickname || currentUser.displayName || '';
                 console.log(`User booking for self: ${targetUserId} (${targetUserName})`);
            }
            // Ha szerkesztés van, a targetUserId nem változik, csak a user (név/cél) és comment

            setModalLoading(true);

            if (isEditing) {
                // --- SZERKESZTÉS ---
                console.log(`Attempting to update booking ${bookingIdToEdit}`);
                const bookingRef = firestore.collection('bookings').doc(bookingIdToEdit);
                const updateData = {
                    comment: bookingComment || null
                };
                // Csak admin módosíthatja a nevet/célt
                if (currentUser.isAdmin) {
                    updateData.user = targetUserName;
                    // Admin a rendszeres jelzőt is módosíthatja (ha eredetileg is az volt)
                    const originalBooking = bookings.find(b => b.id === bookingIdToEdit);
                    if(originalBooking.type === 'recurring') {
                        updateData.type = isRecurring ? 'recurring' : 'single';
                        // Ha single-re vált, kell neki dátum is
                        if(!isRecurring) updateData.date = bookingDataForModal.date;
                    }
                }
                try {
                    await bookingRef.update(updateData);
                    showCustomAlert("Foglalás sikeresen módosítva!");
                    closeBookingModal();
                } catch (error) {
                    console.error("Error updating booking:", error);
                    showCustomAlert(`Hiba a foglalás módosításakor: ${error.message}\nEllenőrizd a Firestore szabályokat!`, 'Hiba');
                } finally {
                    setModalLoading(false);
                }

            } else {
                // --- ÚJ FOGLALÁS ---
                const dataToSave = {
                    roomId: bookingDataForModal.roomId,
                    day: bookingDataForModal.day,
                    timeSlot: bookingDataForModal.timeSlot,
                    date: isRecurring ? null : bookingDataForModal.date,
                    userId: targetUserId,
                    user: targetUserName,
                    comment: bookingComment || null,
                    type: isRecurring ? 'recurring' : 'single',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                console.log("Attempting to save new booking with data:", dataToSave);
                try {
                    await firestore.collection('bookings').add(dataToSave);
                    showCustomAlert("Foglalás sikeresen mentve!");
                    closeBookingModal();
                } catch (error) {
                    console.error("Error adding booking:", error);
                    showCustomAlert(`Hiba a foglalás mentésekor: ${error.message}\nEllenőrizd a Firestore szabályokat!`, 'Hiba');
                } finally {
                    setModalLoading(false);
                }
            }
        }
        function setModalLoading(isLoading) {
            modalConfirmButton.disabled = isLoading;
            modalCancelButton.disabled = isLoading;
            modalSpinner.classList.toggle('hidden', !isLoading);
            modalConfirmText.textContent = isLoading ? 'Mentés...' : (bookingIdToEditInput.value ? 'Módosítás Mentése' : 'Foglalás Mentése');
        }

        // --- Foglalás Törlése / Lemondása ---
        async function deleteBooking(bookingId, roomName, dayDisplay, timeSlot, bookedBy, isRecurring = false) {
              if (!currentUser || !firestore) { showLoginPopup("A törléshez bejelentkezés szükséges."); return; }
             const booking = bookings.find(b => b.id === bookingId);
             if (!booking) { showCustomAlert("A foglalás nem található.", "Hiba"); return; }
             if (currentUser.uid !== booking.userId && !currentUser.isAdmin) {
                 showCustomAlert("Nincs jogosultságod ennek a foglalásnak a törléséhez.", "Hiba");
                 return;
             }
             if (!currentUser.isAdmin && booking.type === 'recurring') {
                  showCustomAlert("Rendszeres foglalást csak adminisztrátor törölhet teljesen. Az 'Egyszeri lemondás' gombbal tudod az aktuális hetet lemondani.", "Hiba");
                  return;
             }
             const confirmationMessage = `Biztosan törölni szeretnéd ezt a foglalást?\nTerem: ${roomName}\nIdőpont: ${dayDisplay} ${timeSlot}\nFoglaló: ${bookedBy}` + (isRecurring ? "\n\nFIGYELEM: Ez egy RENDSZERES foglalás törlése, ami minden hétről eltávolítja!" : "");
             const confirmed = await showCustomConfirm(confirmationMessage, "Megerősítés");
             if (confirmed) {
                 console.log(`Deleting booking: ${bookingId} (Recurring: ${isRecurring})`);
                 try {
                     await firestore.collection('bookings').doc(bookingId).delete();
                     if (isRecurring) {
                         const cancellationsQuery = firestore.collection('cancellations').where('recurringBookingId', '==', bookingId);
                         const cancellationsSnap = await cancellationsQuery.get();
                         if (!cancellationsSnap.empty) {
                             const batch = firestore.batch();
                             cancellationsSnap.forEach(doc => batch.delete(doc.ref));
                             await batch.commit();
                             console.log(`Deleted ${cancellationsSnap.size} cancellations for recurring booking ${bookingId}`);
                         }
                     }
                     showCustomAlert("Foglalás sikeresen törölve.");
                 } catch (error) { console.error("Error deleting booking:", error); showCustomAlert(`Hiba történt a foglalás törlésekor: ${error.message}`, "Hiba"); }
             } else { console.log("Deletion cancelled by user."); }
        }

        async function cancelRecurringInstance(recurringBookingId, dateString, roomName, dayDisplay, timeSlot) {
            if (!currentUser || !firestore) { showLoginPopup("A lemondáshoz bejelentkezés szükséges."); return; }
            const booking = bookings.find(b => b.id === recurringBookingId);
            if (!booking || booking.userId !== currentUser.uid || booking.type !== 'recurring') {
                 showCustomAlert("Csak a saját nevedre szóló rendszeres foglalást mondhatod le erre a napra.", "Hiba");
                 return;
            }
            const confirmationMessage = `Biztosan lemondod a foglalást erre a napra?\nTerem: ${roomName}\nIdőpont: ${dayDisplay} ${timeSlot}`;
            const confirmed = await showCustomConfirm(confirmationMessage, "Lemondás megerősítése");
            if (confirmed) {
                console.log(`Cancelling instance of recurring booking: ${recurringBookingId} for date: ${dateString}`);
                try {
                    const cancellationId = `${recurringBookingId}_${dateString}`;
                    const cancellationRef = firestore.collection('cancellations').doc(cancellationId);
                    await cancellationRef.set({
                        recurringBookingId: recurringBookingId,
                        date: dateString,
                        cancelledByUid: currentUser.uid,
                        cancelledByName: currentUser.nickname || currentUser.displayName || currentUser.email,
                        cancelledAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showCustomAlert("Foglalás erre a napra sikeresen lemondva.");
                } catch (error) {
                    console.error("Error cancelling recurring instance:", error);
                    showCustomAlert(`Hiba történt a lemondáskor: ${error.message}`, "Hiba");
                }
            } else { console.log("Cancellation cancelled by user."); }
        }

        // --- Admin Műveletek ---
        async function addRoom() {
             if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            const roomNameInput = document.getElementById('newRoomName');
            const roomName = roomNameInput.value.trim();
            if (!roomName) return showCustomAlert('Add meg a terem nevét!');
            setAdminLoading(true);
            try { await firestore.collection('rooms').add({ name: roomName }); roomNameInput.value = ''; showCustomAlert('Terem hozzáadva.'); }
            catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function deleteRoom(roomId, roomName) {
              if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
             const confirmed = await showCustomConfirm(`Biztosan törlöd: "${roomName}"?\nFIGYELEM: Ez törli a foglalásait is!`, "Megerősítés");
             if (!confirmed) return;
             setAdminLoading(true);
             try { const batch = firestore.batch(); batch.delete(firestore.collection('rooms').doc(roomId)); const bookingsSnap = await firestore.collection('bookings').where('roomId', '==', roomId).get(); bookingsSnap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); showCustomAlert(`"${roomName}" terem és ${bookingsSnap.size} foglalása törölve.`); }
             catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function addTimeSlot() {
             if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            const valueInput = document.getElementById('newTimeSlotValue');
            const orderInput = document.getElementById('newTimeSlotOrder');
            const value = valueInput.value.trim();
            const order = parseInt(orderInput.value, 10) || 0;
            if (!value || !/^\d{2}:\d{2}\s*-\s*\d{2}:\d{2}$/.test(value)) return showCustomAlert('Hibás idősáv formátum!');
            setAdminLoading(true);
            try { await firestore.collection('timeSlots').add({ value, order }); valueInput.value = ''; showCustomAlert('Idősáv hozzáadva.'); }
            catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function deleteTimeSlot(slotId, slotValue) {
             if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
             const confirmed = await showCustomConfirm(`Biztosan törlöd: "${slotValue}"?`);
            if (!confirmed) return;
            setAdminLoading(true);
            try { await firestore.collection('timeSlots').doc(slotId).delete(); showCustomAlert(`"${slotValue}" idősáv törölve.`); }
            catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function addPendingUser() { // Email alapú meghívó
              if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
             const emailInput = document.getElementById('newPendingUserEmail');
             const nicknameInput = document.getElementById('newPendingUserNickname');
             const isAdminCheckbox = document.getElementById('newPendingUserIsAdmin');
             const email = emailInput.value.trim().toLowerCase();
             const nickname = nicknameInput.value.trim();
             const isAdmin = isAdminCheckbox.checked;
             if (!email || !email.includes('@')) return showCustomAlert('Adj meg egy érvényes email címet!');
             const docRef = firestore.collection('pendingUsers').doc(email);
             const docSnap = await docRef.get();
             if (docSnap.exists) {
                  const confirmed = await showCustomConfirm(`"${email}" már meg van hívva. Frissíted a jogosultságát és a nevét?`, "Megerősítés");
                  if (!confirmed) return;
             }
             const allowedQuery = firestore.collection('allowedUsers').where('email', '==', email);
             const allowedSnap = await allowedQuery.get();
             if (!allowedSnap.empty) { showCustomAlert(`"${email}" már szerepel az engedélyezett felhasználók között.`); return; }

             setAdminLoading(true);
             try { await docRef.set({ isAdmin: isAdmin, nickname: nickname || null }); emailInput.value = ''; nicknameInput.value = ''; isAdminCheckbox.checked = false; showCustomAlert(`"${email}" sikeresen meghívva.`); }
             catch (error) { showCustomAlert(`Hiba a meghíváskor: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function deleteAllowedUser(userId, userEmail) { // UID alapú törlés
             if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            if (userId === currentUser.uid) return showCustomAlert('Magadat nem távolíthatod el.');
            const confirmed = await showCustomConfirm(`Biztosan eltávolítod az engedélyezettek közül: "${userEmail || userId}"?`, "Megerősítés");
            if (!confirmed) return;
            setAdminLoading(true);
            try { await firestore.collection('allowedUsers').doc(userId).delete(); showCustomAlert(`"${userEmail || userId}" eltávolítva az engedélyezettek listájáról.`); }
            catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function deletePendingUser(email) { // Email alapú törlés
             if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
             const confirmed = await showCustomConfirm(`Biztosan törlöd a meghívót: "${email}"?`, "Megerősítés");
            if (!confirmed) return;
            setAdminLoading(true);
            try { await firestore.collection('pendingUsers').doc(email).delete(); showCustomAlert(`"${email}" meghívója törölve.`); }
            catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function toggleAdminStatus(userId, userEmail, currentIsAdmin) { // UID alapú
              if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
             if (userId === currentUser.uid) return showCustomAlert('Saját státuszodat nem módosíthatod.');
             setAdminLoading(true);
             try { await firestore.collection('allowedUsers').doc(userId).update({ isAdmin: !currentIsAdmin }); showCustomAlert(`"${userEmail || userId}" admin státusza módosítva.`); }
             catch (error) { showCustomAlert(`Hiba: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function editUser(userId, currentEmail, currentNickname) { // Allowed user szerkesztése
            if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            const newNickname = prompt(`Add meg "${currentEmail}" új megjelenítendő nevét (üresen hagyva törli):`, currentNickname || '');
            if (newNickname === null) return;
            setAdminLoading(true);
            try { await firestore.collection('allowedUsers').doc(userId).update({ nickname: newNickname.trim() || null }); showCustomAlert(`"${currentEmail}" megjelenítendő neve frissítve.`); }
            catch (error) { showCustomAlert(`Hiba a név frissítésekor: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        async function editPendingUser(email, currentNickname, currentIsAdmin) { // Pending user szerkesztése
            if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            const newNickname = prompt(`Add meg "${email}" új megjelenítendő nevét (üresen hagyva törli):`, currentNickname || '');
            if (newNickname === null) return;
            const confirmed = await showCustomConfirm(`Legyen "${email}" adminisztrátor? (Jelenlegi: ${currentIsAdmin ? 'Igen' : 'Nem'})`, "Jogosultság");
            const newIsAdmin = confirmed;

            setAdminLoading(true);
            try { await firestore.collection('pendingUsers').doc(email).update({ nickname: newNickname.trim() || null, isAdmin: newIsAdmin }); showCustomAlert(`"${email}" meghívott adatai frissítve.`); }
            catch (error) { showCustomAlert(`Hiba a meghívott adatainak frissítésekor: ${error.message}`, "Hiba"); } finally { setAdminLoading(false); }
        }
        function setAdminLoading(isLoading) {
              const overlay = document.getElementById('admin-action-overlay');
             const inputs = adminViewDiv.querySelectorAll('.admin-input');
             const buttons = adminViewDiv.querySelectorAll('.admin-action-button');
             overlay?.classList.toggle('hidden', !isLoading);
             overlay?.classList.toggle('flex', isLoading);
             inputs.forEach(input => input.disabled = isLoading);
             buttons.forEach(button => {
                 const li = button.closest('li');
                 const userId = li?.dataset.id;
                 const isSelfAction = (button.dataset.action === 'delete-user' || button.dataset.action === 'toggle-admin') && userId === currentUser?.uid;
                 button.disabled = isLoading || isSelfAction;
             });
        }
        async function saveAnnouncement() {
            if (!currentUser?.isAdmin || !firestore) return showCustomAlert("Nincs jogosultságod.", "Hiba");
            const message = document.getElementById('admin-announcement').value.trim();
            setAdminLoading(true);
            try {
                await firestore.collection('config').doc('announcement').set({ message: message });
                showCustomAlert("Hirdetmény mentve.");
                announcement = message;
                displayAnnouncement();
            } catch (error) { showCustomAlert(`Hiba a hirdetmény mentésekor: ${error.message}`, "Hiba"); }
            finally { setAdminLoading(false); }
        }

        // --- Eseményfigyelők ---
        function setupEventListeners() {
            console.log("Setting up event listeners...");
            window.addEventListener('hashchange', handleRouteChange);
            googleLoginButton.addEventListener('click', handleGoogleLogin);
            loginPopupCloseButton.addEventListener('click', () => loginPopup.classList.add('hidden'));
            modalCancelButton.addEventListener('click', closeBookingModal);
            modalConfirmButton.addEventListener('click', confirmBooking);
            bookingDetailsCloseButton.addEventListener('click', closeBookingDetailsModal);
            console.log("Base event listeners attached.");
        }

         // --- Admin Eseménykezelő (Delegálás) ---
        function handleAdminActions(event) {
             const button = event.target.closest('.admin-action-button');
            if (!button) return;

            const action = button.dataset.action;
            const li = button.closest('li');
            const id = li?.dataset.id; // UID vagy Doc ID
            const email = li?.dataset.email;
            const isadmin = li?.dataset.isadmin === 'true';
            const nickname = li?.dataset.nickname;
            const nameElement = li?.querySelector('span');
            let name = nameElement?.textContent; // Terem/Idősáv/Email/Nickname

            console.log("Admin action:", action, "ID:", id, "Email:", email, "IsAdmin:", isadmin, "Name:", name, "Nickname:", nickname);

            if (action === 'delete-room' && id && name) deleteRoom(id, name);
            else if (action === 'delete-timeslot' && id && name) deleteTimeSlot(id, name.split(' (')[0]);
            else if (action === 'toggle-admin' && id) toggleAdminStatus(id, email, isadmin);
            else if (action === 'delete-user' && id) deleteAllowedUser(id, email);
            else if (action === 'delete-pending' && email) deletePendingUser(email);
            else if (action === 'edit-user' && id) editUser(id, email, nickname);
            else if (action === 'edit-pending' && email) editPendingUser(email, nickname, isadmin);
            else if (button.id === 'add-room-button') addRoom();
            else if (button.id === 'add-timeslot-button') addTimeSlot();
            else if (button.id === 'add-pending-user-button') addPendingUser();
            else if (button.id === 'save-announcement-button') saveAnnouncement();
        }

        // --- Login Popup Kezelése ---
        function showLoginPopup(message = "Ehhez a művelethez bejelentkezés szükséges.") {
            loginPopupMessage.textContent = message;
            loginPopup.classList.remove('hidden');
        }
        // --- Foglalás Kattintás Kezelése ---
        function handleBookingClick(roomId, roomName, day, timeSlot, dateString) {
            if (!currentUser) {
                showLoginPopup("A foglaláshoz be kell jelentkezni.");
            } else {
                 openBookingModal(roomId, roomName, day, timeSlot, dateString);
            }
        }

        // --- Egyedi Alert/Confirm Modal ---
        let confirmResolve = null;
        function showCustomDialog(message, type = 'alert', title = 'Értesítés') {
            customDialogMessage.innerHTML = message.replace(/\n/g, '<br>');
            customDialogButtons.innerHTML = '';

            if (type === 'confirm') {
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Mégse';
                cancelButton.className = 'px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150';
                cancelButton.onclick = () => { customDialog.classList.remove('active'); if (confirmResolve) confirmResolve(false); };
                customDialogButtons.appendChild(cancelButton);

                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150';
                okButton.onclick = () => { customDialog.classList.remove('active'); if (confirmResolve) confirmResolve(true); };
                customDialogButtons.appendChild(okButton);

            } else {
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = 'px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150';
                okButton.onclick = () => customDialog.classList.remove('active');
                customDialogButtons.appendChild(okButton);
            }
            customDialog.classList.add('active');
            requestAnimationFrame(() => { customDialog.querySelector('.modal-content').classList.add('modal-enter-active'); });
        }
        function showCustomAlert(message, title = 'Értesítés') { showCustomDialog(message, 'alert', title); }
        function showCustomConfirm(message, title = 'Megerősítés') {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                const content = customDialog.querySelector('.modal-content');
                if (!customDialog.classList.contains('active')) {
                     customDialog.classList.add('active');
                     requestAnimationFrame(() => {
                         content.classList.add('modal-enter-active');
                         showCustomDialog(message, 'confirm', title);
                     });
                } else {
                     showCustomDialog(message, 'confirm', title);
                }
            });
        }

        // --- Foglalás Részletei Popup ---
        function showBookingDetails(bookingId, isRecurringMatch = false) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;

            const room = rooms.find(r => r.id === booking.roomId);
            const userDisplay = booking.user || 'Ismeretlen';
            const commentDisplay = booking.comment || 'Nincs megjegyzés';
            const typeDisplay = isRecurringMatch ? 'Rendszeres' : 'Egyszeri';
            const dateDisplay = booking.date ? formatFullDate(new Date(booking.date + 'T00:00:00')) : 'Minden héten';

            bookingDetailsContent.innerHTML = `
                <p><span class="font-semibold">Terem:</span> ${escapeHtml(room?.name || booking.roomId)}</p>
                <p><span class="font-semibold">Időpont:</span> ${escapeHtml(booking.day || '')} ${dateDisplay !== 'Minden héten' ? `(${dateDisplay})` : ''}, ${escapeHtml(booking.timeSlot)}</p>
                <p><span class="font-semibold">Foglaló/Cél:</span> ${escapeHtml(userDisplay)}</p>
                <p><span class="font-semibold">Megjegyzés:</span> ${escapeHtml(commentDisplay)}</p>
                <p><span class="font-semibold">Típus:</span> ${typeDisplay}</p>
            `;

            bookingDetailsActions.innerHTML = ''; // Előző gombok törlése
            const canDelete = currentUser && (currentUser.isAdmin || (currentUser.uid === booking.userId && booking.type === 'single'));
            const canEdit = currentUser && (currentUser.isAdmin || (currentUser.uid === booking.userId && booking.type === 'single')); // Szerkeszteni is csak az tudja, aki törölni

            if (canEdit) {
                 const editButton = document.createElement('button');
                 editButton.textContent = 'Szerkesztés';
                 editButton.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-150';
                 editButton.onclick = () => {
                     closeBookingDetailsModal();
                     // Újra megnyitjuk a foglalási modalt szerkesztési módban
                     openBookingModal(booking.roomId, room?.name || 'Ismeretlen', booking.day, booking.timeSlot, booking.date || formatDateYYYYMMDD(new Date()), booking); // Átadjuk a teljes booking objektumot
                 };
                 bookingDetailsActions.appendChild(editButton);
            }

            if (canDelete) {
                 const deleteButton = document.createElement('button');
                 deleteButton.textContent = 'Foglalás Törlése';
                 deleteButton.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150';
                 deleteButton.onclick = () => {
                     closeBookingDetailsModal();
                     const dayForDelete = booking.date ? `${booking.day} (${formatShortDate(new Date(booking.date + 'T00:00:00'))})` : booking.day;
                     deleteBooking(booking.id, room?.name || 'Ismeretlen terem', dayForDelete, booking.timeSlot, booking.user, isRecurringMatch);
                 };
                 bookingDetailsActions.appendChild(deleteButton);
            }


            bookingDetailsModal.classList.add('active');
            requestAnimationFrame(() => { bookingDetailsModal.querySelector('.modal-content').classList.add('modal-enter-active'); });
        }
        function closeBookingDetailsModal() {
             const content = bookingDetailsModal.querySelector('.modal-content');
             content.classList.remove('modal-enter-active');
             content.classList.add('modal-leave-active');
             setTimeout(() => {
                bookingDetailsModal.classList.remove('active');
                content.classList.remove('modal-leave-active');
             }, 300);
        }


        // --- Óra és Napváltás Figyelő ---
        function startClockAndDayCheck() {
            let lastKnownDate = formatDateYYYYMMDD(new Date());

            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                const now = new Date();
                const timeString = formatTime(now);
                const timeDisplayDaily = document.getElementById('current-time-display');
                const timeDisplayRoom = document.getElementById('current-time-display-room');
                if (timeDisplayDaily) timeDisplayDaily.textContent = timeString;
                if (timeDisplayRoom) timeDisplayRoom.textContent = timeString;

                 if (currentView === 'daily-summary' || currentView === 'room') {
                     const currentSlotValue = getCurrentTimeSlot(timeSlots);
                     const nextSlotValue = !currentSlotValue ? getNextTimeSlot(timeSlots) : null;
                     const viewDiv = currentView === 'daily-summary' ? dailySummaryViewDiv : roomViewDiv;
                     viewDiv.querySelectorAll('.timeslot-box').forEach(box => {
                         const slotValue = box.dataset.timeslot;
                         if (slotValue) {
                             const isActive = slotValue === currentSlotValue;
                             const isNext = slotValue === nextSlotValue;
                             box.classList.toggle('active', isActive);
                             box.classList.toggle('next-up', isNext);
                             const isBooked = box.classList.contains('border-red-500') || box.classList.contains('border-red-400');
                             box.classList.toggle('bg-indigo-100', isActive && !isBooked);
                             box.classList.toggle('border-indigo-700', isActive);
                             box.classList.toggle('bg-red-100', isActive && isBooked);
                             box.classList.toggle('border-red-600', isActive && isBooked);
                             box.classList.toggle('bg-sky-50', isNext && !isBooked);
                             box.classList.toggle('border-sky-300', isNext && !isBooked);
                             box.classList.toggle('bg-orange-50', isNext && isBooked);
                             box.classList.toggle('border-orange-300', isNext && isBooked);

                             const activeIndicator = box.querySelector('.status-indicator.active');
                             const nextIndicator = box.querySelector('.status-indicator.next');
                             if(activeIndicator) activeIndicator.classList.toggle('hidden', !isActive);
                             if(nextIndicator) nextIndicator.classList.toggle('hidden', !isNext);
                         }
                     });
                 }

            }, 1000);

             if (dayCheckInterval) clearInterval(dayCheckInterval);
             dayCheckInterval = setInterval(() => {
                const currentDate = formatDateYYYYMMDD(new Date());
                if (currentDate !== lastKnownDate) {
                    console.log("Midnight detected! Reloading data for new day.");
                    lastKnownDate = currentDate;
                    currentMonday = getMonday(new Date());
                    if (initialPublicDataLoaded && !['loading', 'error'].includes(currentView)) {
                        renderView();
                    }
                }
            }, 60000);
        }

        // --- Admin Üzenet Megjelenítése ---
        function displayAnnouncement() {
            if (currentUser && announcement) { // Csak bejelentkezett usernek és ha van üzenet
                announcementMessageSpan.textContent = announcement;
                announcementBar.classList.remove('hidden');
            } else {
                announcementBar.classList.add('hidden');
            }
        }


        // --- Alkalmazás Indítása ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
